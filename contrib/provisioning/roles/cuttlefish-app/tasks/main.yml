---

- name: copy source
  synchronize: src=../../../../..   dest=/home/
      rsync_opts="--exclude 'contrib' --exclude 'provisioning' --exclude='.git' --exclude='.vagrant' --exclude 'vendor' --exclude='.env' --exclude='config/database.yml'"

- name: bundle install
  command: bundle install --frozen --path=vendor --quiet

- name: database.yml
  template: src=database.yml.j2 dest=/home/cuttlefish/config/database.yml

- name: .env setup
  template: src=env.j2 dest=/home/cuttlefish/.env

- name: revision
  delegate_to: 127.0.0.1
  command: git describe --always
  register: revision

- name: REVISION
  copy: content='{{ revision.stdout }}' dest=/home/cuttlefish/REVISION
